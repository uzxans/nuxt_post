{"version":3,"sources":["../../../src/checkers/biome/cli.ts"],"sourcesContent":["import { exec } from 'node:child_process'\nimport path from 'node:path'\nimport { stripVTControlCharacters as strip } from 'node:util'\nimport { createFrame } from '../../codeFrame.js'\nimport type { NormalizedDiagnostic } from '../../logger.js'\nimport { DiagnosticLevel } from '../../types.js'\nimport type { BiomeOutput } from './types.js'\n\nexport const severityMap = {\n  error: DiagnosticLevel.Error,\n  warning: DiagnosticLevel.Warning,\n  info: DiagnosticLevel.Suggestion,\n} as const\n\nexport function getBiomeCommand(command: string, flags: string, files: string) {\n  const defaultFlags = '--reporter json'\n  if (flags.includes('--flags')) {\n    throw Error(\n      `vite-plugin-checker will force append \"--reporter json\" to the flags in dev mode, please don't use \"--flags\" in \"config.biome.flags\".\nIf you need to customize \"--flags\" in build mode, please use \"config.biome.build.flags\" instead.`,\n    )\n  }\n  return ['biome', command, flags, defaultFlags, files]\n    .filter(Boolean)\n    .join(' ')\n}\n\nexport function runBiome(command: string, cwd: string) {\n  return new Promise<NormalizedDiagnostic[]>((resolve, _reject) => {\n    exec(\n      command,\n      {\n        cwd,\n        maxBuffer: Number.POSITIVE_INFINITY,\n      },\n      (_error, stdout, _stderr) => {\n        resolve([...parseBiomeOutput(stdout, cwd)])\n      },\n    )\n  })\n}\n\nfunction parseBiomeOutput(output: string, cwd: string) {\n  let parsed: BiomeOutput\n  try {\n    parsed = JSON.parse(output)\n  } catch {\n    return []\n  }\n\n  const diagnostics: NormalizedDiagnostic[] = parsed.diagnostics.map((d) => {\n    let file = d.location.path?.file\n    if (file) {\n      // Convert relative path to absolute path\n      file = path.isAbsolute(file) ? file : path.resolve(cwd, file)\n      file = path.normalize(file)\n    }\n\n    const loc = {\n      file: file || '',\n      start: getLineAndColumn(d.location.sourceCode, d.location.span?.[0]),\n      end: getLineAndColumn(d.location.sourceCode, d.location.span?.[1]),\n    }\n\n    const codeFrame = createFrame(d.location.sourceCode || '', loc)\n\n    return {\n      message: `[${d.category}] ${d.description}`,\n      conclusion: '',\n      level:\n        severityMap[d.severity as keyof typeof severityMap] ??\n        DiagnosticLevel.Error,\n      checker: 'Biome',\n      id: file,\n      codeFrame,\n      stripedCodeFrame: codeFrame && strip(codeFrame),\n      loc,\n    }\n  })\n\n  return diagnostics\n}\n\nfunction getLineAndColumn(text?: string, offset?: number) {\n  if (!text || !offset) return { line: 0, column: 0 }\n\n  let line = 1\n  let column = 1\n\n  for (let i = 0; i < offset; i++) {\n    if (text[i] === '\\n') {\n      line++\n      column = 1\n    } else {\n      column++\n    }\n  }\n\n  return { line, column }\n}\n"],"mappings":"AAAA,SAAS,YAAY;AACrB,OAAO,UAAU;AACjB,SAAS,4BAA4B,aAAa;AAClD,SAAS,mBAAmB;AAE5B,SAAS,uBAAuB;AAGzB,MAAM,cAAc;AAAA,EACzB,OAAO,gBAAgB;AAAA,EACvB,SAAS,gBAAgB;AAAA,EACzB,MAAM,gBAAgB;AACxB;AAEO,SAAS,gBAAgB,SAAiB,OAAe,OAAe;AAC7E,QAAM,eAAe;AACrB,MAAI,MAAM,SAAS,SAAS,GAAG;AAC7B,UAAM;AAAA,MACJ;AAAA;AAAA,IAEF;AAAA,EACF;AACA,SAAO,CAAC,SAAS,SAAS,OAAO,cAAc,KAAK,EACjD,OAAO,OAAO,EACd,KAAK,GAAG;AACb;AAEO,SAAS,SAAS,SAAiB,KAAa;AACrD,SAAO,IAAI,QAAgC,CAAC,SAAS,YAAY;AAC/D;AAAA,MACE;AAAA,MACA;AAAA,QACE;AAAA,QACA,WAAW,OAAO;AAAA,MACpB;AAAA,MACA,CAAC,QAAQ,QAAQ,YAAY;AAC3B,gBAAQ,CAAC,GAAG,iBAAiB,QAAQ,GAAG,CAAC,CAAC;AAAA,MAC5C;AAAA,IACF;AAAA,EACF,CAAC;AACH;AAEA,SAAS,iBAAiB,QAAgB,KAAa;AACrD,MAAI;AACJ,MAAI;AACF,aAAS,KAAK,MAAM,MAAM;AAAA,EAC5B,QAAQ;AACN,WAAO,CAAC;AAAA,EACV;AAEA,QAAM,cAAsC,OAAO,YAAY,IAAI,CAAC,MAAM;AAlD5E;AAmDI,QAAI,QAAO,OAAE,SAAS,SAAX,mBAAiB;AAC5B,QAAI,MAAM;AAER,aAAO,KAAK,WAAW,IAAI,IAAI,OAAO,KAAK,QAAQ,KAAK,IAAI;AAC5D,aAAO,KAAK,UAAU,IAAI;AAAA,IAC5B;AAEA,UAAM,MAAM;AAAA,MACV,MAAM,QAAQ;AAAA,MACd,OAAO,iBAAiB,EAAE,SAAS,aAAY,OAAE,SAAS,SAAX,mBAAkB,EAAE;AAAA,MACnE,KAAK,iBAAiB,EAAE,SAAS,aAAY,OAAE,SAAS,SAAX,mBAAkB,EAAE;AAAA,IACnE;AAEA,UAAM,YAAY,YAAY,EAAE,SAAS,cAAc,IAAI,GAAG;AAE9D,WAAO;AAAA,MACL,SAAS,IAAI,EAAE,QAAQ,KAAK,EAAE,WAAW;AAAA,MACzC,YAAY;AAAA,MACZ,OACE,YAAY,EAAE,QAAoC,KAClD,gBAAgB;AAAA,MAClB,SAAS;AAAA,MACT,IAAI;AAAA,MACJ;AAAA,MACA,kBAAkB,aAAa,MAAM,SAAS;AAAA,MAC9C;AAAA,IACF;AAAA,EACF,CAAC;AAED,SAAO;AACT;AAEA,SAAS,iBAAiB,MAAe,QAAiB;AACxD,MAAI,CAAC,QAAQ,CAAC,OAAQ,QAAO,EAAE,MAAM,GAAG,QAAQ,EAAE;AAElD,MAAI,OAAO;AACX,MAAI,SAAS;AAEb,WAAS,IAAI,GAAG,IAAI,QAAQ,KAAK;AAC/B,QAAI,KAAK,CAAC,MAAM,MAAM;AACpB;AACA,eAAS;AAAA,IACX,OAAO;AACL;AAAA,IACF;AAAA,EACF;AAEA,SAAO,EAAE,MAAM,OAAO;AACxB;","names":[]}